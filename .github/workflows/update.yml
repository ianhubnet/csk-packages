name: Update & Upload

on:
  repository_dispatch:
    types: [update]

concurrency:
  group: update-submodules-${{ github.event.client_payload.type }}-${{ github.event.client_payload.name }}
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest

    env:
      FTP_HOST: ${{ secrets.FTP_HOST }}
      FTP_PORT: ${{ secrets.FTP_PORT }}
      FTP_USER: ${{ secrets.FTP_USER }}
      FTP_PASS: ${{ secrets.FTP_PASS }}
      FTP_PATH: ${{ secrets.FTP_PATH }}
      CSK_PAT: ${{ secrets.CSK_PAT }}

    steps:
      - name: Checkout repo with submodules
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CSK_PAT }}
          submodules: true

      - name: Set up Bash (ensure shell with coreutils)
        shell: bash
        run: echo "Shell ready with core utilities"

      - name: Configure Git identity
        shell: bash
        run: |
          git config user.name "ianhub-bot"
          git config user.email "bot@ianhub.net"

      - name: Add or Update Submodule
        shell: bash
        env:
          CSK_TYPES: ${{ vars.CSK_TYPES }}
        run: |
          TYPE="${{ github.event.client_payload.type }}"
          NAME="${{ github.event.client_payload.name }}"
          REPO="${{ github.event.client_payload.repo }}"

          # Validate TYPE against CSK_TYPES JSON
          TYPE_PLURAL=$(echo "$CSK_TYPES" | jq -r --arg key "$TYPE" '.[$key]')
          if [ "$TYPE_PLURAL" = "null" ]; then
            echo "‚ùå Invalid TYPE: '$TYPE'. Must be one of: $(echo "$CSK_TYPES" | jq -r 'keys | join(", ")')"
            exit 1
          fi

          # Determine submodule path
          SUB_PATH="packages/$TYPE_PLURAL/$NAME"

          echo "‚û°Ô∏è Type: $TYPE"
          echo "üì¶ Name: $NAME"
          echo "üîó Repo: $REPO"
          echo "üìÇ Submodule path: $SUB_PATH"

          if [ -d "$SUB_PATH" ]; then
            echo "‚úÖ Submodule exists. Updating..."
            git submodule update --remote "$SUB_PATH"
          else
            echo "‚ûï Submodule doesn't exist. Adding it..."
            mkdir -p "$(dirname "$SUB_PATH")"
            git submodule add "https://${CSK_PAT}@github.com/$REPO" "$SUB_PATH"
            git config -f .gitmodules submodule."$SUB_PATH".url "https://github.com/$REPO"
            git submodule sync
          fi

          git add "$SUB_PATH"
          git add .gitmodules "$SUB_PATH"

          git fetch origin main

          if git diff --cached --quiet; then
            echo "üü¢ No staged changes. Safe to pull..."
            git merge --ff-only origin/main || echo "‚ö†Ô∏è Nothing to merge"
          else
            echo "‚ö†Ô∏è Skipping merge to avoid overwriting staged submodule updates."
          fi

          if git diff --cached --quiet; then
            echo "üü° No changes to commit."
          else
            echo "üìù Committing changes..."
            git commit -m "Auto-update/add submodule: $TYPE/$NAME"
          fi

          echo "üöÄ Pushing to origin (with retry)..."
          for i in 1 2 3; do
            git push && break || {
              echo "‚ùå Push failed. Retry #$i in 3s..."
              sleep 3
            }
          done

          git status -sb
          echo "‚úÖ Submodule update done."

      - name: Download latest release ZIP
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.CSK_PAT }}
        run: |
          ZIP_NAME="${NAME}.zip"
          RELEASE_URL=$(gh release view --repo "$REPO" --json assets --jq '.assets[-1].url')
          if [ -z "$RELEASE_URL" ]; then
            echo "‚ùå No release found for $REPO"
            exit 1
          fi
          curl -L -H "Authorization: token $CSK_PAT" -o "$ZIP_NAME" "$RELEASE_URL"
          echo "‚úÖ Downloaded release ZIP as $ZIP_NAME"

      - name: Upload ZIP to FTP
        shell: bash
        run: |
          REMOTE_PATH="$FTP_PATH/$TYPE_PLURAL/$ZIP_NAME"
          mkdir -p "$(dirname "$REMOTE_PATH")"
          echo "Uploading $ZIP_NAME to $REMOTE_PATH"
          curl -T "$ZIP_NAME" -u "$FTP_USER:$FTP_PASS" "ftp://$FTP_HOST:$FTP_PORT/$REMOTE_PATH"
          echo "‚úÖ FTP upload completed"
