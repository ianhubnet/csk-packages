name: Update Submodules

on:
  repository_dispatch:
    types: [update-submodules]

concurrency:
  group: update-submodules
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo with submodules
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CSK_PAT }}
          submodules: true

      - name: Configure Git
        run: |
          git config --global user.name "CSK Bot"
          git config --global user.email "skeleton@ianhub.net"

      - name: Add or update submodule
        shell: bash
        run: |
          TYPE="${{ github.event.client_payload.type }}"
          REPO="${{ github.event.client_payload.repository }}"
          NAME="${{ github.event.client_payload.name }}"

          echo "Type: $TYPE"
          echo "Name: $NAME"
          echo "Repo: $REPO"

          if [ "$TYPE" = "languages" ]; then
            PATH="packages/languages"
          else
            DIR_NAME="${NAME#*-}"  # strips csk-theme- or csk-module-
            PATH="packages/$TYPE/$DIR_NAME"
          fi

          echo "Path: $PATH"

          if [ -d "$PATH" ]; then
            echo "✅ Submodule exists. Updating..."
            git submodule update --remote "$PATH"
          else
            echo "➕ Submodule doesn't exist. Adding it..."
            mkdir -p "${PATH%/*}"
            git submodule add "https://github.com/$REPO" "$PATH"
          fi

          git add "$PATH"
          git commit -m "Auto-update/add submodule: $TYPE/${NAME:-unknown}" || echo "Nothing to commit"
          git push
