name: Update Submodules

on:
  repository_dispatch:
    types: [update-submodules]

concurrency:
  group: update-submodules-${{ github.event.client_payload.type }}-${{ github.event.client_payload.name }}
  cancel-in-progress: false

jobs:
  update:
    name: Update Package Submodule
    runs-on: ubuntu-latest
    outputs:
      type: ${{ steps.set-vars.outputs.type }}
      type_plural: ${{ steps.set-vars.outputs.type_plural }}
      name: ${{ github.event.client_payload.name }}

    steps:
      - name: Checkout repo with submodules
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CSK_PAT }}
          submodules: true

      - name: Set up Bash (ensure shell with coreutils)
        shell: bash
        run: echo "Shell ready with core utilities"

      - name: Configure Git identity
        shell: bash
        run: |
          git config user.name "ianhub-bot"
          git config user.email "bot@ianhub.net"

      - name: Set vars for later jobs
        id: set-vars
        shell: bash
        env:
          CSK_TYPES: ${{ vars.CSK_TYPES }}
        run: |
          TYPE="${{ github.event.client_payload.type }}"
          TYPE_PLURAL=$(echo "$CSK_TYPES" | jq -r --arg key "$TYPE" '.[$key]')

          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "type_plural=$TYPE_PLURAL" >> $GITHUB_OUTPUT

      - name: Add or Update Submodule
        shell: bash
        env:
          CSK_TYPES: ${{ vars.CSK_TYPES }}
        run: |
          TYPE="${{ github.event.client_payload.type }}"
          TYPE_PLURAL=$(echo "$CSK_TYPES" | jq -r --arg key "$TYPE" '.[$key]')

          if [ "$TYPE_PLURAL" = "null" ]; then
            echo "âŒ Invalid TYPE: '$TYPE'. Must be one of: $(echo "$CSK_TYPES" | jq -r 'keys | join(", ")')"
            exit 1
          fi

          REPO="${{ github.event.client_payload.repo }}"
          NAME="${{ github.event.client_payload.name }}"
          SUB_PATH="packages/$TYPE_PLURAL/$NAME"

          echo "âž¡ï¸ Type: $TYPE"
          echo "ðŸ“¦ Name: $NAME"
          echo "ðŸ”— Repo: $REPO"
          echo "ðŸ“‚ Submodule path: $SUB_PATH"

          if [ -d "$SUB_PATH" ]; then
            echo "âœ… Submodule exists. Updating..."
            git submodule update --remote "$SUB_PATH"
          else
            echo "âž• Submodule doesn't exist. Adding it..."
            mkdir -p "$(dirname "$SUB_PATH")"
            git submodule add "https://${{ secrets.CSK_PAT }}@github.com/$REPO" "$SUB_PATH"

            # Cleanup the URL from .gitmodules
            git config -f .gitmodules submodule."$SUB_PATH".url "https://github.com/$REPO"
            sed -i "s|https://.*@github.com/|https://github.com/|g" .gitmodules
            git submodule sync
          fi

          git add "$SUB_PATH"

          # Always add submodule path and .gitmodules in case it was added/changed
          git add .gitmodules "$SUB_PATH"

          # Fetch latest remote and merge only if nothing staged
          git fetch origin main

          if git diff --cached --quiet; then
            echo "ðŸŸ¢ No staged changes. Safe to pull..."
            git merge --ff-only origin/main
          else
            echo "âš ï¸ Skipping merge to avoid overwriting staged submodule updates."
          fi

          if git diff --cached --quiet; then
            echo "ðŸŸ¡ No changes to commit."
          else
            echo "ðŸ“ Committing changes..."
            git commit -m "Auto-update/add submodule: $TYPE_PLURAL/${NAME:-unknown}"
          fi

          echo "ðŸš€ Pushing to origin (with retry)..."
          for i in 1 2 3; do
            git push && break || {
              echo "âŒ Push failed. Retry #$i in 3s..."
              sleep 3
            }
          done

          git status -sb

          echo "âœ… Done."

  post-update:
    name: Upload Package Release to FTP
    needs: update
    runs-on: ubuntu-latest

    steps:
      - name: Download latest release ZIP
        run: |
          REPO="${{ github.event.client_payload.repo }}"
          NAME="${{ github.event.client_payload.name }}"
          API_URL="https://api.github.com/repos/$REPO/releases/latest"

          echo "ðŸ” Fetching latest release metadata..."
          curl -L -H "Authorization: token ${{ secrets.CSK_PAT }}" \
            "$API_URL" > latest.json

          ZIP_URL=$(jq -r '.assets[0].browser_download_url' latest.json)
          VERSION=$(jq -r '.tag_name' latest.json)

          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸ“¥ ZIP URL: $ZIP_URL"

          if [ -z "$ZIP_URL" ] || [ "$ZIP_URL" == "null" ]; then
            echo "âŒ No release asset found. Aborting."
            exit 1
          fi

          curl -L -o "${NAME}.zip" "$ZIP_URL"

          echo "ZIP=${NAME}.zip" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Upload to FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: ${{ secrets.FTP_HOST }}
          port: ${{ secrets.FTP_PORT }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          local-dir: ./
          server-dir: ${{ secrets.FTP_PATH }}${{ needs.update.outputs.type_plural }}/
          exclude: |
            **/*
            !${{ env.ZIP }}
