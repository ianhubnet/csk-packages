name: Update Submodules (Trusted Dispatch)

on:
  repository_dispatch:
    types: [update-submodules]

jobs:
  update:
    runs-on: ubuntu-latest

    env:
      GIT_AUTHOR_NAME: "ianhub-bot"
      GIT_AUTHOR_EMAIL: "bot@ianhub.net"
      GIT_RETRY_COUNT: 3

    steps:
      - name: Validate dispatcher origin
        shell: bash
        run: |
          echo "üîç Validating dispatcher origin..."
          SENDER_REPO=$(jq -r '.repository.full_name' "$GITHUB_EVENT_PATH")
          EXPECTED_REPO="ianhubnet/github-actions"

          if [[ "$SENDER_REPO" != "$EXPECTED_REPO" ]]; then
            echo "‚ùå Unauthorized dispatch source: $SENDER_REPO"
            echo "Expected: $EXPECTED_REPO"
            exit 1
          fi
          echo "‚úÖ Dispatcher validated from $SENDER_REPO"

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CSK_PAT }} # Internal PAT used for trusted hub updates
          submodules: true

      - name: Configure Git
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

      - name: Parse payload
        id: payload
        shell: bash
        run: |
          TYPE=$(jq -r '.client_payload.type' "$GITHUB_EVENT_PATH")
          NAME=$(jq -r '.client_payload.name' "$GITHUB_EVENT_PATH")
          REPO=$(jq -r '.client_payload.repo' "$GITHUB_EVENT_PATH")
          SUBPATH=$(jq -r '.client_payload.subpath' "$GITHUB_EVENT_PATH")

          echo "‚û°Ô∏è Type: $TYPE"
          echo "‚û°Ô∏è Name: $NAME"
          echo "‚û°Ô∏è Repo: $REPO"
          echo "‚û°Ô∏è Submodule Path: $SUBPATH"

          if [[ -z "$TYPE" || -z "$NAME" || -z "$REPO" ]]; then
            echo "‚ùå Missing payload fields"
            exit 1
          fi

          echo "TYPE=$TYPE" >> $GITHUB_ENV
          echo "NAME=$NAME" >> $GITHUB_ENV
          echo "REPO=$REPO" >> $GITHUB_ENV
          echo "SUBPATH=$SUBPATH" >> $GITHUB_ENV

      - name: Update or add submodule
        shell: bash
        run: |
          echo "üîß Processing submodule..."
          SUBPATH="${SUBPATH:-packages/${TYPE}s/${NAME}}"
          echo "üìÇ Final submodule path: $SUBPATH"

          if [ -d "$SUBPATH" ]; then
            echo "üîÑ Submodule exists ‚Äî updating..."
            git submodule update --remote "$SUBPATH"
          else
            echo "‚ûï Adding new submodule..."
            mkdir -p "$(dirname "$SUBPATH")"
            git submodule add "https://github.com/$REPO" "$SUBPATH"
          fi

          git add "$SUBPATH" .gitmodules
          if git diff --cached --quiet; then
            echo "üü¢ No submodule changes detected."
          else
            git commit -m "Auto-update submodule: $NAME ($TYPE)"
          fi

      - name: Push changes (with retries)
        shell: bash
        run: |
          for i in $(seq 1 $GIT_RETRY_COUNT); do
            git push && break || {
              echo "‚ùå Push failed (attempt $i/$GIT_RETRY_COUNT)... retrying in 5s"
              sleep 5
            }
          done

          echo "‚úÖ Submodule sync completed successfully."
