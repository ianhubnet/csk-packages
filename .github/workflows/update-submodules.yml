name: Update Submodules

on:
  repository_dispatch:
    types: [update-submodules]

concurrency:
  group: update-submodules-${{ github.event.client_payload.type }}
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo with submodules
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CSK_PAT }}
          submodules: true

      - name: Configure Git identity
        shell: bash
        run: |
          git config user.name "ianhub-bot"
          git config user.email "bot@ianhub.net"

      - name: Add or Update Submodule
        shell: bash
        env:
          CSK_TYPES: ${{ vars.CSK_TYPES }}
        run: |
          TYPE="${{ github.event.client_payload.type }}"
          TYPE_PLURAL=$(echo "$CSK_TYPES" | jq -r --arg key "$TYPE" '.[$key]')

          if [ "$TYPE_PLURAL" = "null" ]; then
            echo "‚ùå Invalid TYPE: '$TYPE'. Must be one of: $(echo "$CSK_TYPES" | jq -r 'keys | join(", ")')"
            exit 1
          fi

          REPO="${{ github.event.client_payload.repo }}"
          NAME="${{ github.event.client_payload.name }}"
          SUB_PATH="packages/$TYPE_PLURAL/$NAME"
          echo "‚û°Ô∏è Type: $TYPE"
          echo "üì¶ Name: $NAME"
          echo "üîó Repo: $REPO"
          echo "üìÇ Submodule path: $SUB_PATH"

          if [ -d "$SUB_PATH" ]; then
            echo "‚úÖ Submodule exists. Updating..."
            git submodule update --remote "$SUB_PATH"
          else
            echo "‚ûï Submodule doesn't exist. Adding it..."
            mkdir -p "$(dirname "$SUB_PATH")"
            git submodule add "https://${{ secrets.CSK_PAT }}@github.com/$REPO" "$SUB_PATH"
            git config -f .gitmodules submodule."$SUB_PATH".url "https://github.com/$REPO"
            git submodule sync
          fi

          git add "$SUB_PATH" .gitmodules

          # Commit if any changes
          if git diff --cached --quiet; then
            echo "üü° No changes to commit."
          else
            git commit -m "Auto-update/add submodule: $TYPE_PLURAL/${NAME:-unknown}"
          fi

          # Robust push loop: retries if remote changed
          until git push; do
            echo "‚ùå Push failed. Pulling latest changes and retrying..."
            git fetch origin main
            git merge --ff-only origin/main || exit 1
            sleep 2
          done

          git status -sb
          echo "‚úÖ Done."
